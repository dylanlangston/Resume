name: Build

on:
  push:
    branches: ["main"]
    paths:
      - 'src/**'
      - 'Makefile'
      - 'Dockerfile'
      - '.github/workflows/Build.yaml'
    
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: build-${{ github.ref }}
  cancel-in-progress: true

jobs:
  Build:
    name: "Build Resume PDF"
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        id: checkout
        uses: actions/checkout@v5
      - name: Checkout Submodules
        id: submodules
        run: make setup-git-clone
      - name: Build Resume
        id: build
        run: make build-docker release
      - name: Commit Changes to Repository
        if: github.ref == 'refs/heads/main' && github.repository == 'dylanlangston/resume'
        id: commit
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git checkout main
          git add .
          git commit -m "Update: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" || echo "No changes to commit"
          git push origin main
      - name: Prepare Github Pages artifact
        id: rename
        run: mkdir --parents ./publish; mv ./out/resume.md.html.pdf ./publish/index.html;cp ./publish/index.html ./publish/404.html; mv ./out/social-preview.png ./publish/social-preview.png
      - name: Upload GitGub Pages artifact
        id: upload-html
        uses: actions/upload-pages-artifact@v4
        with:
          path: './publish'
      - name: Setup GitGub Pages
        uses: actions/configure-pages@v5
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4